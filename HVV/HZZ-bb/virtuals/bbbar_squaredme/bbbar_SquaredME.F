*#define CHECK

#if 0
* bbbar_SquaredME.F
* assembly of squared matrix element
* generated by FormCalc 7.5 on 17-Oct-2016 13:26
#endif

#include "bbbar_vars.h"

************************************************************************

	RealType function bbbar_sumup(CCloop, CCtree)
	implicit none

#include "bbbar_vars.h"

	ComplexType CCloop(1), CCtree(1)
	ComplexType m

	bbbar_sumup = 0

	m = 0
	m = m + CCloop(1)*MatSUN(1,1)
	bbbar_sumup = bbbar_sumup + Re(Conjugate(CCtree(1))*m)
	end

************************************************************************

	subroutine bbbar_SquaredMEHel(result, flags)
	implicit none
	RealType result(*)
	integer flags

#include "bbbar_vars.h"

	RealType bbbar_sumup
	external bbbar_sumup

* BEGIN ABBR_HEL
	call bbbar_abbr0hel
	TEST(flags, BIT_LOOP)
	call bbbar_abbr1hel
	ENDTEST(flags, BIT_LOOP)
* END ABBR_HEL

* BEGIN FF_INI
	Ctree(1) = 0

	Cloop(1) = 0
* END FF_INI

* BEGIN FF_TREE
	call bbbar_born

	result(1) = result(1) + bbbar_sumup(Ctree, Ctree)
* END FF_TREE

	TEST(flags, BIT_LOOP)
* BEGIN FF_LOOP
	call bbbar_self
	call bbbar_vert
	call bbbar_box

	result(2) = result(2) + 2*bbbar_sumup(Cloop, Ctree)
* END FF_LOOP
	ENDTEST(flags, BIT_LOOP)
	end

************************************************************************

	subroutine bbbar_SquaredME(result, helicities, flags)
	implicit none
	RealType result(*)
	integer*8 helicities
	integer flags

#include "bbbar_vars.h"

* BEGIN VARDECL
	external bbbar_SquaredMEHel

	integer Hel1, Hel2, Hel3, Hel4, Hel5
	equivalence (Hel(1), Hel1)
	equivalence (Hel(2), Hel2)
	equivalence (Hel(3), Hel3)
	equivalence (Hel(4), Hel4)
	equivalence (Hel(5), Hel5)

	data MatSUN /1*bogus/
* END VARDECL

#include "inline.h"

	PREP(seq,seq_end, vec,vec_end, varangle,varangle_end, vars,vars_end)

* BEGIN INVARIANTS
	S = SInvariant(k(1),k(2))
	T = TInvariant(k(1),k(3))
	T14 = TInvariant(k(1),k(4))
	U = TInvariant(k(2),k(3))
	T24 = TInvariant(k(2),k(4))
	S34 = SInvariant(k(3),k(4))
* END INVARIANTS

	TEST(flags, BIT_RESET)
* BEGIN ABBR_S
	seq(1) = seq(1) + 1
	INI_S(seq)
	call bbbar_abbr0s
	TEST(flags, BIT_LOOP)
	call bbbar_abbr1s
	ENDTEST(flags, BIT_LOOP)
* END ABBR_S
	ENDTEST(flags, BIT_RESET)

* BEGIN ABBR_ANGLE
	seq(2) = seq(2) + 1
	INI_ANGLE(seq)
	call bbbar_abbr0angle
	TEST(flags, BIT_LOOP)
	call bbbar_abbr1angle
	ENDTEST(flags, BIT_LOOP)
* END ABBR_ANGLE

* BEGIN RES_INI
	result(1) = 0
	result(2) = 0
* END RES_INI

* BEGIN HEL_LOOPS
	LOOP_HEL(Hel1)
	TEST(helicities, BIT_HEL(1))

	LOOP_HEL(Hel2)
	TEST(helicities, BIT_HEL(2))

	LOOP_HEL(Hel3)
	TEST(helicities, BIT_HEL(3))

	LOOP_HEL(Hel4)
	TEST(helicities, BIT_HEL(4))

	LOOP_HEL(Hel5)
	TEST(helicities, BIT_HEL(5))

	EXEC(bbbar_SquaredMEHel, result, flags)

	ENDTEST(helicities, BIT_HEL(5))
	ENDLOOP_HEL(Hel5)

	ENDTEST(helicities, BIT_HEL(4))
	ENDLOOP_HEL(Hel4)

	ENDTEST(helicities, BIT_HEL(3))
	ENDLOOP_HEL(Hel3)

	ENDTEST(helicities, BIT_HEL(2))
	ENDLOOP_HEL(Hel2)

	ENDTEST(helicities, BIT_HEL(1))
	ENDLOOP_HEL(Hel1)
* END HEL_LOOPS

	SYNC(result)
	DEINI(seq)

#ifdef CHECK
	print *, 'S =', S
	print *, 'T =', T
	print *, 'T14 =', T14
	print *, 'U =', U
	print *, 'T24 =', T24
	print *, 'S34 =', S34
	print *, 'tree =', result(1)
	print *, 'loop =', result(2)
	stop
#endif

* END SQUAREDME
	end

